<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>
  </head>
  <body>

    <!-- The first button the user sees -->
    <button id="linkButton">Connect your bank</button>

    <!-- Hidden second button that shows up after success, or you could reuse the same button -->
    <button id="anotherBankButton" style="display:none;">Connect another bank</button>

    <script>
      var userEmail = '<?= userEmail ?>';
      var spreadsheetId = '<?= spreadsheetId ?>';

      // 1) Called when user first clicks "Connect your bank"
      function getLinkToken() {
        google.script.run
          .withFailureHandler(function(error) {
            console.error('Error getting link token:', error);
            alert('An error occurred while creating the link token: ' + error.message);
          })
          .withSuccessHandler(initializePlaidLink)
          .createLinkToken(userEmail);  // We'll get a new link token each time
      }

      // 2) Build Plaid Link once we have the link token
      function initializePlaidLink(linkToken) {
        var handler = Plaid.create({
          token: linkToken,
          onSuccess: function(public_token, metadata) {
            // Exchange public token for access token
            google.script.run
              .withFailureHandler(function(error) {
                console.error('Error exchanging public token:', error);
                alert('An error occurred while exchanging the public token: ' + error.message);
              })
              .withSuccessHandler(onExchangeSuccess)
              .getAccessToken(public_token, userEmail, spreadsheetId);
          },
          onExit: function(err, metadata) {
            if (err != null) {
              console.error('Plaid API Error:', err);
              alert('An error occurred: ' + (err.display_message || err.error_message));
            } else {
              console.log('User exited Plaid Link:', metadata);
            }
          },
          onEvent: function(eventName, metadata) {
            console.log('Event: ' + eventName, metadata);
          }
        });
        handler.open();
      }

      // 3) Once we get a success from the serverâ€™s getAccessToken, 
      //    let user connect another bank or close out.
      function onExchangeSuccess(data) {
        alert('Bank account linked successfully!\nIf you want to add another, click "Connect another bank".');
        console.log('Access Token and Item ID:', data);

        // Show the "Connect another bank" button
        document.getElementById('anotherBankButton').style.display = 'inline';
      }

      // 4) The main button user sees first
      document.getElementById('linkButton').onclick = function() {
        getLinkToken();
      };

      // 5) The "another bank" button can do the same getLinkToken => new link => new flow
      document.getElementById('anotherBankButton').onclick = function() {
        getLinkToken();
      };
    </script>
  </body>
</html>
